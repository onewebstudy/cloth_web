<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
    <title>库存管理</title>
	<link rel="shortcut  icon" type="image/x-icon" href="/iext/favicon.ico" media="screen"  />
    <!-- Bootstrap -->
    <link rel="stylesheet" href="../build/css/bootstrap.css">
    <link rel="stylesheet" href="../build/css/index.css">
    <link rel="stylesheet" href="../build/css/style.css">
	<link rel="stylesheet" href="../build/css/main.css">
	<link rel="stylesheet" href="../build/css/pageNav.css">
    <link href="../build/css/blue.css" rel="stylesheet">
	<script src="../build/js/jquery-1.11.3.min.js"></script>
	<script src="../build/js/art-template.js"></script>
</head>
<body>
	<div class="link">
	</div>
	<div class="head">
	</div>
	<div class="indexbody" id="indexbody">
		
	</div>
	<script id="executions" type="text/html">
	<div class="bread">
		<a href="../views/index.html">首页</a> >> 库存管理
	</div>
	<div class="searchdiv clearfix">
        <span class="production" onclick="addstock()" style="margin-right:16px;"><img src="../build/img/add1.png" style="margin-right:0;">添加库存</span>
        <span class="production" onclick="outstock()"><img src="../build/img/excel.png" style="margin-right:0;">导出表格</span>
		<div class="searchmin">
			<span>工艺：</span>
			<select id="type" onchange="search()">
				<option value="">全部</option>
				<option value="1"{{if type==1}}selected{{/if}}>A</option>
				<option value="2"{{if type==2}}selected{{/if}}>B</option>
				<option value="3"{{if type==3}}selected{{/if}}>C</option>
				<option value="4"{{if type==4}}selected{{/if}}>D</option>
			</select>
			<input type="text" placeholder="请输入货号或印花" id="text" value="{{text}}">
			<img src="../build/img/search.png" class="searchimg" onclick="search()">
		</div>
	</div>
	<div class="tablediv">
		<table>
			<tr>
				<th>库存编号</th>
				<th style="width: 10%;">仓库编号</th>
				<th style="width: 15%;">货号</th>
				<th style="width: 15%;">印花</th>
				<th style="width: 5%;">尺寸</th>
				<th style="width: 5%;">工艺</th>
				<th style="width: 10%;">加入库存时间</th>
				<th>操作</th>
			</tr>
			{{if pagelist.total>0}}
			{{each pagelist.result as value i}}
			<tr>
                <td>{{value.ssid}}</td>
                <td>{{value.storeid}}</td>
				<td>{{value.itemnum}}</td>
				<td>{{value.stamp}}</td>
				<td>{{value.size}}</td>
				<td>{{if value.type==1}}A{{/if}}{{if value.type==2}}B{{/if}}{{if value.type==3}}C{{/if}}{{if value.type==4}}D{{/if}}</td>
				<td>{{value.creattime}}</td>
				<td class="dosome">
					<div class="showul">
						<span onclick="confirmdelete('{{value.ssid}}','delectstock','是否要删除该库存？');">删除</span>
					</div>
				</td>
			</tr>
			{{/each}}
			{{/if}}
		</table>
		{{if pagelist.total>0}}<nav aria-label="Page navigation" class="page-nav-outer" id="PageNavId"></nav>{{/if}}
			{{if pagelist.total<=0}}
				<div class="emptyContent">
					<img src="../build/img/no_no.png">
					<p>暂无库存相关内容</p>
				</div>
			{{/if}}
	</div>
	</script>
<!-- 停产信息 -->
<div class="modal fade tipModal" id="addmodal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="width:520px;">
        <div class="modal-content">
           <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><img src="../build/img/win_close.png"></button>
              <div class="modal-title" style="padding-top: 14px;padding-left: 16px;color: #666;font-weight:bold;">添加库存<span class="inforn">填写产品信息</span></div>
           </div>
           <div class="modal-body clearfix bottomlen" style="padding-bottom:0;">
               <div class="stockbox">
                   <div>
                       <span>货号：</span>
                       <input type="text" placeholder="请输入货号" id="itemnum1">
                   </div>
                   <div>
                        <span>数量：</span>
                        <input type="number" placeholder="请输入数量" id="num1">
				   </div>
				   <div>
					<span>尺寸：</span>
					<select id="size1">
						<option>90</option>
						<option>100</option>
						<option>110</option>
						<option>120</option>
						<option>130</option>
						<option>140</option>
						<option>150</option>
						<option>XS</option>
						<option>S</option>
						<option>M</option>
						<option>L</option>
						<option>XL</option>
						<option>2XL</option>
						<option>3XL</option>
						<option>4XL</option>
					</select>
			   </div>
                   <div>
                        <span>印花：</span>
                        <input type="text" placeholder="请输入印花" id="stamp1" onkeyup="changeserch()">
                        <input type="hidden" id="stid">
                        <div class="printul" id="printul">
         				
                        </div>
                   </div>
                   <div>
                        <span>工艺：</span>
                        <select id="type1">
                            <option value="1">A</option>
                            <option value="2">B</option>
                            <option value="3">C</option>
                            <option value="4">D</option>
                        </select>
                   </div>
                   <div>
                        <span>仓库：</span>
                        <input type="number" placeholder="请输入仓库编号" id="storeid1">
                   </div>
			   </div>
			   <div class="stockerror"></div>
           </div>
           <div class="btdiv clearfix">
              <button class="btn btn-blue yesbtn" onclick="addclick()">确定</button>
              <a class="btn btn-default nobtn" data-dismiss="modal"  aria-hidden="true">取 消</a>
          </div>
        </div><!-- /.modal-content -->
     </div><!-- /.modal-dialog -->
</div><!-- /.modal弹框 myModal-delete删除 -->
<script type="text/html" id="imglistli">
	<ul>
		{{each list as value}}
		<li onclick="clickli(this)">{{value.stname}},{{value.size}}
			<input type="hidden" class="liimggurl" value="{{value.filepath}}">
			<input type="hidden" class="liimggsize" value="{{value.size}}">
			<input type="hidden" class="listid" value="{{value.stid}}">
			<input type="hidden" class="listname" value="{{value.stname}}"></li>
		{{/each}}
	</ul>
</script>

<script src="../build/js/bootstrap.js"></script>
<script src="../build/js/jquery.icheck.min.js"></script>
<script src="../build/js/main.js"></script>
<script src="../build/js/pageNav.js"></script>
<script src="../build/js/JsBarcode.all.js"></script>
<script src="../build/js/html2canvas.js"></script>
<script>
var arr_tip_userid = new Array();
var woid = getQueryString('woid');
var successnum;
var errornums;
if(woid==null){
	woid='';
}
var boid = getQueryString('boid');
if(boid==null){
	boid='';
}
//搜索
function search(pageNum){
	var myDate = new Date();
	var text=$("#text").val();
	var type=$("#type").val();
	$.ajax({
		url:headurl+"/OrderController/storeList?URL="+myDate.getMinutes()+myDate.getSeconds(),
		data:{text:text,type:type,pageNum:pageNum},
		success:function(data){
			var data = eval('(' + data + ')');
			if(data.success==1){
			var html = template('executions',data.body);
			document.getElementById('indexbody').innerHTML = html;
			icheckinit();
			if(data.body.pagelist.total>0){
				var pageNavObj = null;//用于储存分页对象
				pageNavObj = new PageNavCreate("PageNavId",{ pageCount:data.body.pagelist.pages, currentPage:data.body.pagelist.pageNum, perPageNum:data.body.pagelist.pageSize});
				pageNavObj.afterClick(search);
			}
			}else {
					tipError(data.msg);
				}
		}
	})
	arr_tip_userid=[];
}
$(function(){
	$('.link').load('../views/link.html');
	$('.head').load('../views/header2.html');
	var myDate = new Date();
	$.ajax({
		url:headurl+"/OrderController/storeList?URL="+myDate.getMinutes()+myDate.getSeconds(),
		success:function(data){
			var data = eval('(' + data + ')');
			if(data.success==1){
			var html = template('executions',data.body);
			document.getElementById('indexbody').innerHTML = html;
			icheckinit();
			if(data.body.pagelist.total>0){
				var pageNavObj = null;//用于储存分页对象
				pageNavObj = new PageNavCreate("PageNavId",{ pageCount:data.body.pagelist.pages, currentPage:data.body.pagelist.pageNum, perPageNum:data.body.pagelist.pageSize});
				pageNavObj.afterClick(search);
			}
			}else {
					tipError(data.msg);
				}
		}
	})
})
//增加库存
function addstock() {
    $("#addmodal").modal("show");
}
//确定添加库存
function addclick() {
	$("button").attr("disabled",true);
	var itemnum = safeStr($.trim($("#itemnum1").val()));
	var num = $("#num1").val();
	var stamp = $("#stamp1").val();
	var stampid = $("#stid").val();
	var type = $("#type1").val();
	var storeid = $("#storeid1").val();
	var size = $("#size1").val();
	var regPos = /^[1-9]\d*$/;
	if(!regPos.test(num)){
		$(".stockerror").html("数量请填写正整数，不能为空");
		$("button").attr("disabled",false);
		return false;
	}
	if(!regPos.test(storeid)){
		$(".stockerror").html("仓库请填写正整数，不能为空");
		$("button").attr("disabled",false);
		return false;
	}
	if(!stampid) {
		$(".stockerror").html("请选择印花不要修改印花名称");
		$("button").attr("disabled",false);
		return false;
	}
	$.ajax({
		url:headurl+"/OrderController/addStore",
		type:"post",
		data:{itemnum:itemnum,num:num,stamp:stamp,type:type,storeid:storeid,size:size},
		success:function(data){
			$("button").attr("disabled",false);
			$("#addmodal").modal("hide");
			var data = eval('(' + data + ')');
			if(data.success==1){
				tipSuccess("添加成功");
				if(data.body.type ==1){
					var e = 'A';
				}else if(data.body.type ==2){
					var e = 'B';
				}else if(data.body.type ==3){
					var e = 'C';
				}
				else if(data.body.type ==4){
					var e = 'D';
				}
				var a = e + data.body.itemnum;
				var b = data.body.stamp;
				var c = data.body.size;
				for(var i = 0;i < data.body.store.length;i++) {
					var d = data.body.store[i].storeid;
					window.external.OpenForm(data.body.store[i].productid);
					window.external.givesize(a,b,c,d,e,"");
					window.external.printjs3(1,"Gprinter GP-1524T");
				}
				$("#addmodal").find("input").val("");
				search();
			}else {
					tipError(data.msg);
				}
		}
	})
}
//导出列表
function outstock() {
	var myDate = new Date();
	location.href=headurl+"/OrderController/storeExport?URL="+myDate.getMinutes()+myDate.getSeconds();
}

//展示列表
function showlist(text,size){
	var myDate = new Date();
	$.ajax({
		url:headurl+"/StampController/stampnamelist?URL="+myDate.getMinutes()+myDate.getSeconds(),
		data:{text:text,size:size},
		success:function(data){
			var data = eval('(' + data + ')');
			if(data.success==1){
			var html = template('imglistli',data.body);
			document.getElementById('printul').innerHTML = html;
			if(data.body.list.length>0){
				$('.printul').css('display','block');
			}
			}else {
					tipError(data.msg);
				}
		}
	})
}
//点击li
function clickli(_this){
	var imgurl = $(_this).find('.liimggurl').val();
	var imgsize = $(_this).find('.liimggsize').val();
	var stid = $(_this).find('.listid').val();
	var stname = $(_this).find('.listname').val();
	$('#filepath').val(imgurl);
	$('#size').val(imgsize);
	$('#stid').val(stid);
	$('#stamp1').val(stname);
	$('.printul').css('display','none');
}
//失去焦点，结果消失
// $('#stname').blur(function(){
// 	$('.printul').css('display','none');
// })
$('#addmodal').find('input').focus(function(){
	$('.printul').css('display','none');
})
$('#stamp1').focus(function(){
	$('.printul').css('display','none');
	var text=$('#stamp1').val();
	var size = $('#size1').val();
	showlist(text,size);
})
function changeserch(){
	$('#filepath').val('');
	$('#stid').val('');
	$('.printul').css('display','none');
	var text=$('#stamp1').val();
	var size = $('#size1').val();
	showlist(text,size);
}
//删除库存
function delectstock(id) {
	var myDate = new Date();
	$.ajax({
		url:headurl+"/OrderController/deleteStore?URL="+myDate.getMinutes()+myDate.getSeconds(),
		type:"post",
		data:{ssid:id},
		success:function(data){
			var data = eval('(' + data + ')');
			if(data.success==1){
				tipSuccess("删除成功","search");
			}else {
					tipError(data.msg);
				}
		}
	})
}
//初始化选择框
function icheckinit(){
	var tid = 0;
	$( "tr" ).hover( function() {
		var _this = this;
	   tid = setTimeout( function() {
		   $(_this).find('.exename').css('display','block');
	    }, 2000 );
	}, function() {
		$(this).find('.exename').css('display','none');
	    clearTimeout( tid );//当在1秒内退出了hover事件就取消计时代码
	} );
	$('.tablediv td').hover(function(){
		$(this).parents('tr').find('td').css('background',' #E7F3FC');
	},function(){
		$(this).parents('tr').find('td').css('background',' #FFF')
	});
	$('.allover').on('ifChecked',function(e){
			$('.allover').iCheck('check');
			var num = $('#stopmodal').find('.modalnum').html();
			$('#stopmodal').find('.stopnuminput').val(num);
			changenum();
	});
	$('#text').bind('keypress',function(event){
            if(event.keyCode == "13")    
            {
                search();
            }
        });
}

//安全转码
function safeStr(str){
	return str.replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g, "&quot;").replace(/'/g, "&#039;");
}
</script>
</body>
</html>